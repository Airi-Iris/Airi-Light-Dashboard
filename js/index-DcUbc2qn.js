import{o as ae}from"./omit-e2GViC_v.js";import{d as A,b as o,b3 as te,e,E as j,x as ue,b4 as i,T as y,Q as z,s as w,B as C,g as s,p as G,ar as le,W as ne,D as se,u as re,Y as ie,X as oe,c as ce,w as L,ax as de,av as ve,O as pe,F as g,m as U,n as H,a7 as $,f as fe,k as W,ao as me,al as ge,ap as E,a1 as N,aq as be,a0 as ye,i as Q,R as b,j as he,v as xe,b5 as q,an as Ce}from"./index-DYGX83NG.js";import{N as D}from"./Badge-DdTZ2lYy.js";import"./_baseClone-BvZlpTTU.js";import"./last-DXTTfs9a.js";const J={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},X=""+new URL("../assets/fallback-BjFffESB.jpg",import.meta.url).href;function Y(l){return typeof l=="function"||Object.prototype.toString.call(l)==="[object Object]"&&!ue(l)}const K=A(l=>{const p=o(),h=o(!1),k=te(p,c=>{c[0].isIntersecting&&(h.value=!0,k.stop())});return()=>{let c,u;return e("div",{ref:p},[l.avatar?h.value?e(j,{src:l.avatar,round:!0,onError:f=>{console.log(X),f.target.src=X}},null):e(j,{round:!0},Y(c=l.name.charAt(0))?c:{default:()=>[c]}):e(j,{round:!0},Y(u=l.name.charAt(0))?u:{default:()=>[u]})])}});K.props=["avatar","name"];const Be=A({props:{onCallback:{type:Function,required:!0}},setup(l){const p=o(""),h=o(i.Pass),k=Object.entries(J).filter(([u])=>u!=="Audit").map(([u,f])=>({value:i[u],key:u,label:f})),c=()=>{l.onCallback(h.value,p.value)};return()=>e(G,{class:"mt-6"},{default:()=>[e(y,{label:"状态"},{default:()=>[e(z,{value:h.value,onUpdateValue:u=>h.value=u,options:k},null)]}),e(y,{label:"原因"},{default:()=>[e(w,{type:"textarea",value:p.value,onUpdateValue:u=>p.value=u,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),e("div",{class:"flex justify-end"},[e(C,{round:!0,type:"primary",onClick:c},{default:()=>[s("发送")]})])]})}}),ke=A({props:{url:String,errorMessage:String,status:[String,Number]},setup(l){return()=>e("div",{class:"flex items-center space-x-2"},[e("a",{target:"_blank",href:l.url,rel:"noreferrer"},[l.url]),typeof l.status<"u"&&(l.errorMessage?e(le,null,{trigger(){return e("div",{class:"h-2 w-2 rounded-full bg-red-400"},null)},default(){return l.errorMessage}}):e("div",{class:"h-2 w-2 rounded-full bg-green-300"},null))])}}),Ae=A({setup(){const l=ne(),p=se(),k=re(ie).viewport.value.mobile,c=o(l.query.state??i.Pass),{data:u,fetchDataFn:f,pager:O,loading:Z}=oe((a,n)=>async(r=l.query.page||1,d=50)=>{const v=l.query.state??i.Pass,_=await b.api.links.get({params:{page:r,size:d,state:v|0}});a.value=_.data,n.value=_.pagination}),B=ce(),F=()=>({avatar:"",name:"",type:q.Friend,url:"",id:null,description:"",state:i.Pass}),x=o(!1),t=o(F()),S=o(!1),R=o(0),T=o(0);L(()=>l.query.state,async a=>{await f()}),L(()=>l.query.page,async a=>{await f()},{immediate:!0});const m=o({}),I=async()=>{const a=await b.api.links.state.get();m.value=a};de(()=>{I()});const ee=async()=>{const a=t.value.id;if(a){const n=await b.api.links(a).put({data:ae(t.value,["id","created","hide"])}),r=u.value.findIndex(d=>d.id==a);n.state!=c.value?(u.value.splice(r,1),I()):u.value[r]={...u.value[r],...Ce(t.value)}}else{const{data:n}=await b.api.links.post({data:{...t.value}});u.value.unshift(n)}B.success("操作成功"),x.value=!1,t.value=F()},M=o(),P=async()=>{const a=B.loading("检查中",{duration:2e5});try{const n=await b.api.links.health.get({timeout:2e5});M.value=Object.entries(n).reduce((r,[d,v])=>({...r,[d.toLowerCase()]:v}),{}),R.value=Object.entries(n).reduce((r,[d,v])=>v.status!==200?r+1:r,0),T.value=Object.entries(n).reduce((r,[d,v])=>v.status===200?r+1:r,0),B.success("检查完成"),S.value=!0}catch(n){console.error(n)}finally{requestAnimationFrame(()=>{a.destroy()})}},V=ve();return()=>e(g,null,[e(pe,{className:"space-x-2"},{default:()=>[e(g,null,[e(U,{icon:e("i",{class:"icon-[mingcute--add-line]"},null),className:"bg-accent",onClick:()=>{t.value=F(),x.value=!0},name:"添加新朋友"},null),e(U,{icon:e("i",{class:"icon-[mingcute--heartbeat-line]"},null),className:"bg-[#2080f0]",variant:"info",onClick:P,name:"检查友链可用性"},null)])]}),e("div",{class:"relative -mt-12 flex w-full grow flex-col"},[e("div",{dir:"ltr","data-orientation":"horizontal",class:"flex flex-row sticky top-16 z-[1] -ml-4 h-[42px] -mt-8 w-[calc(100%+2rem)] bg-white/80 backdrop-blur dark:bg-zinc-900/80 border-b-[0.5px] border-zinc-200 dark:border-neutral-900"},[e("h1",{class:"w-[50px] center flex mr-4 ml-4 font-bold text-[16px]"},[s("朋友们")])]),e("div",{class:"mt-16 p-16 pt-0"},[e(H,{class:"mt-16 rounded-md",headerExtra:()=>k?null:e(g,null,[e("div",{class:"shrink grow"},null),e("div",{class:"flex grow-0 items-center gap-4"},[e("div",{class:"flex gap-2"},[e(g,null,[e($,{icon:e("i",{class:"icon-[mingcute--add-line] size-4"},null),variant:"primary",onClick:()=>{t.value=F(),x.value=!0},description:"添加新朋友"},null),e($,{icon:e("i",{class:"icon-[mingcute--heartbeat-line] size-4"},null),class:"bg-[#2080f0]",onClick:P,description:"检查友链可用性"},null)])])])])},{header(){return e(g,null,[e("div",{class:"flex flex-col mb-4 select-none"},[e("h1",{class:"flex items-center text-[1.73rem]"},[s("朋友们")]),e("h2",{class:"opacity-80 text-sm inline-flex"},[s("朋友们 · 列表"),e("span",{class:fe("ml-4 center text-center inline-flex",S.value?"text-[#2080f0]":"text-orange-400")},[S.value?e(g,null,[e("span",null,["=>",s("友链可用性检查返回如下结果:")]),e(W,{type:"error",size:"small",class:"h-[16px] mx-2"},{default:()=>[s("失效友链:"),R.value]}),e(W,{type:"success",size:"small",class:"h-[16px] mr-2"},{default:()=>[s("有效友链:"),T.value]}),e("span",null,[s("详情请查看表格")])]):"=>未运行友链可用性检查<="])])])])},default(){return e(g,null,[e(me,{class:"min-h-[30px]",size:"medium",value:c.value,onUpdateValue:a=>{c.value=a,p.replace({name:ge.Friend,query:{state:a}})}},{default:()=>[e(E,{name:i.Pass,tab:"朋友们"},null),e(E,{name:i.Audit,tab:()=>e(D,{value:m.value.audit,processing:!0},{default:()=>[e(N,null,{default:()=>[s("待审核")]})]})},null),e(E,{name:i.Outdate,tab:()=>e(D,{value:m.value.outdate,type:"info"},{default:()=>[e(N,null,{default:()=>[s("过时的")]})]})},null),e(E,{name:i.Reject,tab:()=>e(D,{value:m.value.reject,type:"warning"},{default:()=>[e(N,null,{default:()=>[s("已拒绝")]})]})},null),e(E,{name:i.Banned,tab:()=>e(D,{value:m.value.banned,type:"error"},{default:()=>[e(N,null,{default:()=>[s("封禁的")]})]})},null)]}),e(be,{loading:Z.value,data:u,class:"mt-2",nTableProps:{maxHeight:"calc(100vh - 22rem)"},columns:[{title:"头像",key:"avatar",width:80,render(a){return e(K,{name:a.name,avatar:a.avatar},null)}},{title:"名称",key:"name",render(a){return e("a",{target:"_blank",href:a.url,rel:"noreferrer"},[a.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(a){const n=M.value?.[a.id];return e(ke,{url:a.url,errorMessage:n?.message,status:n?.status},null)}},{title:"类型",key:"type",width:80,render(a){return["朋友","收藏"][a.type|0]}},{title:"对方邮箱",key:"email",render(a){return e("a",{href:`mailto:${a.email}`},[a.email])}},{title:"结识时间",key:"created",width:80,render(a){return e(ye,{time:a.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(a){return e(Q,{wrap:!1},{default:()=>[a.state==i.Audit&&e(g,null,[e(C,{quaternary:!0,size:"tiny",type:"primary",onClick:async()=>{await b.api.links.audit(a.id).patch(),B.success(`通过了来自${a.name}的友链邀请`);const n=u.value.findIndex(r=>r.id==a.id);u.value.splice(n,1),m.value.audit--}},{default:()=>[s("通过")]}),e(C,{quaternary:!0,size:"tiny",type:"info",onClick:async()=>{V.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>e(Be,{onCallback:async(n,r)=>{await b.api.links.audit.reason(a.id).post({data:{state:n,reason:r}}),B.success(`已发送友链结果给「${a.name}」`);const d=u.value.findIndex(v=>v.id==a.id);u.value.splice(d,1),m.value.audit--,V.destroyAll()}},null)})}},{default:()=>[s("理由")]})]),e(C,{quaternary:!0,size:"tiny",type:"info",onClick:n=>{x.value=!0,t.value={...a}}},{default:()=>[s("编辑")]}),e(he,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await b.api.links(a.id).delete(),B.success("删除成功"),await f(O.value.currentPage),a.state==i.Audit&&m.value.audit--}},{trigger:()=>e(C,{quaternary:!0,type:"error",size:"tiny"},{default:()=>[s("移除")]}),default:()=>e("span",{class:"max-w-48"},[s("确定要删除友链 "),a.name,s(" ?")])})]})}}],onFetchData:f,pager:O},null)])}}),e(xe,{transformOrigin:"center",show:x.value,onUpdateShow:a=>void(x.value=a)},{default:()=>[e(H,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:t.value.id?`编辑: ${t.value.name}`:"新增"},{default:()=>[e(G,null,{default:()=>[e(y,{label:"名字",required:!0},{default:()=>[e(w,{autofocus:!0,value:t.value.name,onInput:a=>void(t.value.name=a)},null)]}),e(y,{label:"头像"},{default:()=>[e(w,{autofocus:!0,value:t.value.avatar,onInput:a=>void(t.value.avatar=a)},null)]}),e(y,{label:"网址",required:!0},{default:()=>[e(w,{autofocus:!0,value:t.value.url,onInput:a=>void(t.value.url=a)},null)]}),e(y,{label:"描述"},{default:()=>[e(w,{autofocus:!0,value:t.value.description,onInput:a=>void(t.value.description=a)},null)]}),e(y,{label:"类型"},{default:()=>[e(z,{placeholder:"选择类型",options:[{label:"朋友",value:q.Friend},{label:"收藏",value:q.Collection}],value:t.value.type,onUpdateValue:a=>void(t.value.type=a|0)},null)]}),t.value.id&&e(y,{label:"状态"},{default:()=>[e(z,{placeholder:"选择状态",options:Object.entries(J).map(([a,n])=>({label:n,value:i[a]})),value:t.value.state,onUpdateValue:a=>void(t.value.state=a|0)},null)]})]}),e("div",{class:"text-right"},[e(Q,{size:12,align:"center",inline:!0},{default:()=>[e(C,{type:"primary",onClick:ee,round:!0},{default:()=>[s("确定")]}),e(C,{onClick:()=>{x.value=!1,t.value=F()},round:!0},{default:()=>[s("取消")]})]})])]})]})])])])}});export{Ae as default};
