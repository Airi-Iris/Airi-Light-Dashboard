import{d as y,bp as k,av as S,e,n as L,F as N,g as r,a7 as O,k as R,L as I,B as v,j as W,R as d,b as A,a2 as U,p as j,T as f,s as D,aY as g,i as q,bZ as V,x as _,cT as x}from"./index-DrqTzKeg.js";import{c as B}from"./cloneDeep-DwHimFPf.js";import{N as T,a as E}from"./ListItem-B495cGJh.js";import{N as M}from"./Thing-BSiU63cz.js";import{N as P}from"./LayoutContent-rp3tOS9M.js";import{N as G,a as C}from"./Grid-CqLZMRUq.js";import"./_baseClone-F2EjVhq3.js";const p={TO_VISITOR:1,TO_ADMIN:2,TO_SYSTEM:4,ALL:7};function m(s){return typeof s=="function"||Object.prototype.toString.call(s)==="[object Object]"&&!_(s)}const H="webhook.list",ae=y({setup(){const{data:s,mutate:c}=k(H,async()=>d.api.webhooks.get()),i=S(),a=o=>{i.create({title:"Create Webhook",content:()=>e(J,{formData:o,onSubmit:()=>{c()}},null),class:"!w-[800px] !max-w-[80vw]"})},l=o=>{i.create({title:"Webhook Dispatches",content:()=>e(Y,{hookId:o},null),class:"!w-[600px] !max-w-[80vw]"})};return()=>e(N,null,[e("div",{class:"relative -mt-12 flex w-full grow flex-col"},[e("div",{class:"mt-[5rem] p-12 pt-[6px]"},[e(L,{class:"rounded-md border border-solid border-border"},{header(){return e(N,null,[e("div",{class:"flex justify-between border-b border-border"},[e("div",{class:"flex flex-col mb-4 select-none"},[e("h1",{class:"flex items-center text-[1.73rem]"},[r("Webhooks")]),e("h2",{class:"opacity-80 text-sm inline-flex mt-2"},[r("附加功能 · Webhooks")])]),e("div",{class:"flex grow-0 items-center gap-4"},[e("div",{class:"flex gap-2"},[e(O,{class:"",icon:e("i",{class:"icon-[mingcute--add-line] size-4"},null),variant:"primary",onClick:()=>a(),description:"Add Webhook"},null)])])])])},default(){return e(T,{hoverable:!0,clickable:!0},{default:()=>[s.value?.data.map(o=>e("div",{role:"button",tabindex:0,onClick:()=>{l(o.id)}},[e(E,{key:o.id},{default(){return e(M,{title:o.payloadUrl},{description(){return e("div",{class:"space-x-2"},[o.events.map(n=>e(R,{size:"small",type:"primary",round:!0},m(n)?n:{default:()=>[n]}))])},avatar(){return e("div",{class:["h-2 w-2 rounded-full",o.enabled?"bg-green-500":"bg-gray-500"]},null)}})},suffix(){return e("div",{onClick:n=>n.stopPropagation()},[e(I,null,{default:()=>[e(v,{round:!0,onClick:()=>{a(o)}},{default:()=>[r("编辑")]}),e(W,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await d.api.webhooks(o.id).delete(),c()}},{trigger:()=>e(v,{round:!0,type:"error",ghost:!0},{default:()=>[r("移除")]}),default:()=>e("span",{class:"max-w-48"},[r("确定要删除 ?")])})]})])}})]))]})}})])])])}}),J=y({props:{formData:{type:Object,required:!1},onSubmit:{type:Function,required:!1}},setup(s){const{data:c}=k("webhook.events",async()=>d.api.webhooks.events.get()),i=s.formData!==void 0,a=A(B(s.formData)??{events:[],enabled:!0,scope:p.TO_SYSTEM}),{destroyAll:l}=S(),o=U(()=>new Set(a.value.events)),n=async()=>{if(!i)await d.api.webhooks.post({data:{...a.value}});else{const u={...a.value};u.secret||Reflect.deleteProperty(u,"secret"),await d.api.webhooks(s.formData.id).patch({data:u})}l(),s.onSubmit?.()};return()=>{let u;return e("div",{class:"mt-5"},[e(j,null,{default:()=>[e(f,{required:!0,label:"Payload URL"},{default:()=>[e(D,{value:a.value.payloadUrl,onUpdateValue:t=>{a.value.payloadUrl=t}},null)]}),e(f,{required:!0,label:"Secret"},{default:()=>[e(D,{value:a.value.secret,type:"password",showPasswordOn:"click",onUpdateValue:t=>{a.value.secret=t}},null)]}),e(f,{required:!0,label:"Events"},{default:()=>[e(P,{nativeScrollbar:!1,embedded:!0,class:"!h-[400px] !bg-transparent"},{default:()=>[e(G,{cols:2,xGap:12,yGap:12},{default:()=>[e(C,null,{default:()=>[e(g,{checked:o.value.has("all"),onUpdateChecked:t=>{t?a.value.events=["all"]:a.value.events=[]}},{default:()=>[r("ALL")]})]}),c.value?.data.map(t=>e(C,null,{default:()=>[e(g,{checked:o.value.has(t)||o.value.has("all"),onUpdateChecked:h=>{h?a.value.events.push(t):a.value.events=a.value.events.filter(b=>b!==t)}},m(t)?t:{default:()=>[t]})]}))]})]})]}),e(f,{required:!0,label:"Scope"},{default:()=>[e(q,{wrap:!0},m(u=Object.keys(p).map(t=>{const h=p[t],b=a.value.scope;return e(g,{checked:(b&h)===h||b===p.ALL,onUpdateChecked:F=>{F?a.value.scope|=p[t]:a.value.scope&=~p[t]}},m(t)?t:{default:()=>[t]})}))?u:{default:()=>[u]})]}),e(f,{required:!0,label:"Enabled"},{default:()=>[e(V,{onUpdateValue:t=>{a.value.enabled=t},value:a.value.enabled},null)]}),e("div",{class:"flex justify-end"},[e(v,{onClick:n,type:"primary",round:!0},{default:()=>[r("提交")]})])]})])}}}),Y=y({props:{hookId:{type:String,required:!0}},setup(s){const{data:c}=k(`webhook.events${s.hookId}`,async()=>await d.api.webhooks(s.hookId).get({params:{page:1,size:20}}).then(l=>l.data)),i=S(),a=l=>{i.create({title:"Webhook Dispatch Detail",class:"!w-[800px] !max-w-[80vw]",content:()=>e("div",{class:"max-h-[80vh] overflow-auto"},[e("div",{class:"flex flex-col gap-4"},[e(v,{class:"absolute right-4 top-4",type:"primary",onClick:()=>{d.api.webhooks.redispatch(l.id).post().then(()=>{message.success("Re-Dispatch Success")}).catch(()=>{message.error("Re-Dispatch Failed")})}},{default:()=>[r("Re-Dispatch")]}),e("p",null,[r("Status: "),l.status,r(" "),l.success?"✅":"❌"]),e("p",null,[r("Header:")]),e(x,{code:w(l.headers),class:"p-4"},null),e("p",null,[r("Payload:")]),e(x,{code:w(l.payload),class:"p-4"},null),e("p",null,[r("Response:")]),e(x,{code:w(l.response),class:"p-4"},null)])])})};return()=>e("div",null,[e(T,null,{default:()=>[c.value?.map(l=>e(E,{key:l.id},{default:()=>[e("div",{class:"flex items-center space-x-4"},[e("div",{class:["h-2 w-2 rounded-full",l.success?"bg-green-500":"bg-red-500"]},null),e("div",{class:"w-[30px]"},[l.status]),e("span",{style:{flex:2}},[new Date(l.timestamp).toLocaleString()]),e("span",{style:{flex:2}},[l.event]),e(v,{onClick:()=>a(l),quaternary:!0,type:"primary",class:"justify-self-end",style:{flex:1}},{default:()=>[r("Detail")]})])]}))]})])}}),w=s=>JSON.stringify(JSON.parse(s),null,2);export{J as EditWebhookForm,ae as default};
